<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CyberHub | The Grid</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #00f3ff;
            --bg: #000000;
            --surface: #0f0f0f;
            --border: #262626;
            --text: #f5f5f5;
            --text-grey: #a8a8a8;
            --btn-grey: #363636;
            --danger: #ff3040;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* UTILS */
        .hidden { display: none !important; }
        .cyber-font { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
        .btn { cursor: pointer; border: none; font-weight: 600; transition: 0.2s; border-radius: 4px; }
        .clickable { cursor: pointer; }
        
        /* LOADER */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #333; 
            border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* AUTH */
        #auth-view {
            width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center;
            flex-direction: column; background: #000;
        }
        .auth-box { width: 350px; padding: 40px; border: 1px solid var(--border); text-align: center; background: var(--surface); }
        .auth-input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); color: #fff; margin-bottom: 10px; border-radius: 4px; }
        .auth-btn { width: 100%; padding: 10px; background: var(--primary); color: #000; margin-top: 10px; font-weight: bold; }
        .link { color: var(--primary); cursor: pointer; margin-top: 10px; display: inline-block; font-size: 0.9rem; }

        /* LAYOUT */
        #app-view { display: none; height: 100vh; }
        .main-layout { display: grid; grid-template-columns: 250px 1fr 320px; max-width: 1400px; margin: 0 auto; height: 100%; }

        /* SIDEBAR */
        .sidebar { border-right: 1px solid var(--border); padding: 40px 20px; display: flex; flex-direction: column; height: 100%; }
        .logo { font-size: 1.8rem; color: var(--primary); margin-bottom: 50px; padding-left: 10px; }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 8px; color: var(--text); cursor: pointer; margin-bottom: 8px; }
        .nav-item:hover { background: rgba(0, 243, 255, 0.1); color: var(--primary); }
        .nav-item.active { font-weight: 700; color: var(--primary); }
        .nav-item i { font-size: 22px; width: 30px; }

        /* CONTENT */
        .content-area { overflow-y: scroll; position: relative; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        
        /* HOME HERO */
        .hero-section {
            text-align: center; padding: 60px 20px 40px 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px;
            background: linear-gradient(180deg, rgba(0, 243, 255, 0.05) 0%, rgba(0,0,0,0) 100%);
        }
        .hero-title { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; color: var(--primary); text-shadow: 0 0 20px rgba(0, 243, 255, 0.4); margin-bottom: 10px; font-weight: 900; letter-spacing: 2px; }
        .hero-sub { color: var(--text-grey); font-size: 1rem; letter-spacing: 1.5px; text-transform: uppercase; }
        .empty-feed { text-align: center; padding: 50px; color: var(--text-grey); font-family: 'Orbitron', sans-serif; }

        /* FEED */
        .feed-container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .post-card { margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        .post-img { width: 100%; border-radius: 5px; border: 1px solid var(--border); }
        .post-actions { padding: 10px 0; font-size: 24px; display: flex; gap: 20px; }
        .liked { color: #ff3040; }

        /* RIGHT SIDEBAR */
        .right-sidebar { padding: 30px 20px; overflow-y: auto; }
        .sugg-title { font-weight: bold; color: var(--text-grey); margin-bottom: 20px; font-size: 14px; }
        .user-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .u-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .u-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }
        .u-btn { color: var(--primary); font-size: 12px; font-weight: bold; background: none; border: none; cursor: pointer; }

        /* SEARCH VIEW */
        #view-search { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
        .search-input { width: 100%; padding: 15px 20px; background: var(--surface); border: 1px solid var(--border); color: #fff; border-radius: 30px; font-size: 16px; outline: none; margin-bottom: 20px; }
        .search-input:focus { border-color: var(--primary); }
        .user-result { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid var(--border); }
        
        /* MESSAGES */
        #view-messages { display: flex; height: 100%; width: 100%; overflow: hidden; }
        .msg-sidebar { width: 35%; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: #000; }
        .msg-header { padding: 20px; font-size: 20px; font-weight: bold; border-bottom: 1px solid var(--border); }
        .contact-list { flex: 1; overflow-y: auto; }
        
        /* Contact Item & Delete Button */
        .contact-item { 
            display: flex; align-items: center; gap: 15px; padding: 15px 20px; 
            cursor: pointer; transition: 0.2s; border-bottom: 1px solid #1a1a1a; 
            position: relative; 
        }
        .contact-item:hover, .contact-item.active { background: #111; }
        
        .delete-chat-btn {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            color: var(--text-grey); font-size: 14px; padding: 8px;
            display: none; /* Hidden by default */ z-index: 5;
        }
        .contact-item:hover .delete-chat-btn { display: block; }
        .delete-chat-btn:hover { color: var(--danger); }

        .c-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }
        .c-name { font-weight: 600; font-size: 14px; }
        .c-user { font-size: 12px; color: var(--text-grey); }
        
        .msg-window { flex: 1; display: flex; flex-direction: column; background: var(--surface); position: relative; }
        
        .chat-header-bar { 
            padding: 10px 20px; border-bottom: 1px solid var(--border); background: #080808; 
            display: flex; align-items: center; gap: 15px;
        }
        .header-info { display: flex; flex-direction: column; justify-content: center; }
        #chat-header-name { font-weight: bold; font-size: 16px; color: #fff; line-height: 1.2; }
        #chat-header-status { font-size: 12px; color: var(--text-grey); }
        .online-dot { color: #00ff00; font-size: 10px; margin-right: 4px; }

        .back-btn { display: none; font-size: 20px; cursor: pointer; }
        .messages-feed { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        
        .msg-bubble { 
            padding: 10px 16px; border-radius: 18px; max-width: 70%; font-size: 14px; word-wrap: break-word; position: relative; 
            min-width: 60px;
        }
        .msg-mine { align-self: flex-end; background: var(--primary); color: #000; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background: #262626; color: #fff; border-bottom-left-radius: 4px; }
        .msg-username { font-size: 10px; color: var(--primary); margin-bottom: 2px; font-weight: bold;}
        .msg-image { max-width: 200px; border-radius: 8px; margin-top: 5px; cursor: pointer; border: 1px solid #444; }
        .msg-file-link { color: #fff; text-decoration: underline; display: block; margin-top: 5px; font-size: 12px; }
        
        .msg-time { font-size: 9px; text-align: right; margin-top: 4px; opacity: 0.7; font-weight: 600; }
        .msg-mine .msg-time { color: #000; }
        .msg-other .msg-time { color: #aaa; }

        .chat-input-zone { padding: 15px; background: #000; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        .chat-input { flex: 1; padding: 12px 20px; background: #111; border: 1px solid var(--border); color: #fff; border-radius: 25px; outline: none; }
        
        .btn-send {
            width: 45px; height: 45px; border-radius: 50%; background: var(--primary); 
            border: none; display: flex; align-items: center; justify-content: center;
            color: #000; font-size: 18px; cursor: pointer; box-shadow: 0 0 10px rgba(0,243,255,0.4);
            transition: 0.2s;
        }
        .btn-send:hover { transform: scale(1.1); background: #fff; }
        .btn-send:disabled { background: var(--btn-grey); box-shadow: none; cursor: not-allowed; }

        .empty-chat { display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: var(--text-grey); }
        .empty-icon { font-size: 50px; margin-bottom: 20px; color: #333; border: 2px solid #333; padding: 30px; border-radius: 50%; }
        
        #file-preview-area {
            display: none; padding: 10px 20px; background: #111; border-top: 1px solid var(--border); 
            color: var(--primary); font-size: 13px; align-items: center; justify-content: space-between;
        }

        /* --- PROFILE --- */
        #view-profile { max-width: 935px; margin: 0 auto; padding: 30px 20px; }
        .profile-header { display: flex; margin-bottom: 44px; align-items: flex-start; }
        .p-avatar-container { flex-grow: 1; margin-right: 30px; display: flex; justify-content: center; }
        .p-pic-xl { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid var(--primary); }
        .p-details { flex-grow: 2; color: #f5f5f5; }
        .p-top-row { display: flex; align-items: center; margin-bottom: 20px; gap: 20px; flex-wrap: wrap; }
        .p-username { font-size: 24px; font-weight: 400; font-family: 'Inter'; margin: 0; }
        
        .btn-insta-edit { background-color: var(--btn-grey); border: none; border-radius: 8px; color: #fff; font-weight: 600; padding: 7px 16px; font-size: 14px; cursor: pointer; }
        .btn-insta-action { background-color: var(--primary); border: none; border-radius: 8px; color: #000; font-weight: 600; padding: 7px 20px; font-size: 14px; cursor: pointer; }
        .settings-cog { font-size: 20px; cursor: pointer; margin-left: 10px; }

        .p-stats-row { display: flex; gap: 40px; margin-bottom: 20px; font-size: 16px; list-style: none; padding: 0; }
        .stat-num { font-weight: 700; color: #fff; }
        .p-bio-section { font-size: 14px; line-height: 1.5; }
        .p-realname { font-weight: 600; display: block; margin-bottom: 4px; }
        .profile-tabs { border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 60px; margin-bottom: 20px; }
        .tab-item { padding-top: 15px; color: var(--text-grey); font-size: 12px; font-weight: 600; letter-spacing: 1px; cursor: pointer; display: flex; align-items: center; gap: 6px; border-top: 1px solid transparent; margin-top: -1px; }
        .tab-item.active { color: #fff; border-top: 1px solid #fff; }
        .profile-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .grid-post-wrap { position: relative; aspect-ratio: 1/1; cursor: pointer; overflow: hidden; }
        .grid-img { width: 100%; height: 100%; object-fit: cover; }

        /* MOBILE */
        .mobile-nav { display: none; }
        @media (max-width: 1000px) { .main-layout { grid-template-columns: 250px 1fr; } .right-sidebar { display: none; } }
        @media (max-width: 800px) {
            .main-layout { display: block; }
            .sidebar { display: none; }
            .mobile-nav { position: fixed; bottom: 0; width: 100%; background: #000; border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 15px; z-index: 100; }
            .feed-container, #view-profile { padding-bottom: 80px; }
            .profile-header { flex-wrap: wrap; margin-bottom: 24px; gap: 15px; }
            .p-avatar-container { margin-right: 0; }
            .p-pic-xl { width: 77px; height: 77px; }
            .p-details { width: calc(100% - 100px); }
            .p-top-row { margin-bottom: 10px; flex-direction: column; align-items: flex-start; gap: 10px; }
            .p-stats-row { width: 100%; justify-content: space-around; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 12px 0; margin-bottom: 10px; order: 2; }
            .p-bio-section { margin-bottom: 15px; order: 1; }
            .profile-grid { gap: 3px; }
            #view-messages { display: block; }
            .msg-sidebar { width: 100%; height: 100%; border-right: none; }
            .msg-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; transform: translateX(100%); transition: transform 0.3s ease; }
            .msg-window.open { transform: translateX(0); }
            .back-btn { display: block; }
            .content-area { height: calc(100vh - 60px); }
        }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: var(--surface); padding: 30px; width: 400px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
        .settings-list { list-style: none; padding: 0; text-align: left; }
        .settings-list li { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; color: #fff; }
        .settings-list li:hover { background: #1a1a1a; padding-left: 20px; color: var(--primary); }
        .settings-list li:last-child { border-bottom: none; color: #ff3040; }

        /* FLOATING ACTION BUTTON (NEW POST) */
        .fab-btn {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background: var(--primary); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); z-index: 1000;
            font-size: 30px; color: #000; transition: 0.2s;
        }
        .fab-btn:hover { transform: scale(1.1); }
        @media (max-width: 800px) { .fab-btn { bottom: 80px; right: 20px; width: 50px; height: 50px; font-size: 24px; } }

        /* NEW POST MODAL PREVIEW */
        .new-post-preview { max-width: 100%; max-height: 300px; object-fit: contain; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--border); display: none; }

    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="auth-view">
        <div class="auth-box">
            <h1 class="cyber-font" style="color:var(--primary); margin-bottom: 20px;">CYBERHUB</h1>
            <div id="login-form">
                <input type="email" id="l-email" class="auth-input" placeholder="Email">
                <input type="password" id="l-pass" class="auth-input" placeholder="Password">
                <button class="auth-btn btn" onclick="login()">Log In</button>
                <div class="link" onclick="toggleAuth()">Create New Account</div>
            </div>
            <div id="reg-form" class="hidden">
                <input type="text" id="r-name" class="auth-input" placeholder="Full Name">
                <input type="text" id="r-user" class="auth-input" placeholder="Username">
                <input type="email" id="r-email" class="auth-input" placeholder="Email">
                <input type="password" id="r-pass" class="auth-input" placeholder="Password">
                <button class="auth-btn btn" onclick="register()">Sign Up</button>
                <div class="link" onclick="toggleAuth()">Back to Login</div>
            </div>
        </div>
    </div>

    <div id="app-view">
        <div class="main-layout">
            
            <div class="sidebar">
                <div class="logo cyber-font">CYBERHUB</div>
                <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-home"></i> <span>Home</span></div>
                <div class="nav-item" onclick="nav('search', this)"><i class="fas fa-search"></i> <span>Search</span></div>
                <div class="nav-item" onclick="nav('messages', this)"><i class="fas fa-envelope"></i> <span>Messages</span></div>
                <div class="nav-item" onclick="nav('profile', this)"><i class="fas fa-user"></i> <span>Profile</span></div>
                <div class="nav-item" onclick="openSettings()" style="margin-top:auto;"><i class="fas fa-bars"></i> <span>More</span></div>
            </div>

            <div class="content-area">
                
                <div id="view-home" class="view-section">
                    <div class="hero-section">
                        <h1 class="hero-title">CYBERHUB</h1>
                        <p class="hero-sub">CONNECT • ENCRYPT • SHARE</p>
                    </div>
                    <div class="feed-container" id="feed-list"></div>
                </div>

                <div id="view-search" class="view-section hidden">
                    <input type="text" class="search-input" id="search-input" placeholder="Search users..." onkeyup="searchUsers()">
                    <div id="search-results"></div>
                </div>

                <div id="view-messages" class="view-section hidden">
                    <div class="msg-sidebar">
                        <div class="msg-header">Chats</div>
                        <div class="contact-list" id="contact-list">
                            <div style="padding:20px; color:#555;">Loading...</div>
                        </div>
                    </div>
                    <div class="msg-window" id="msg-window">
                        <div class="empty-chat" id="empty-chat-state">
                            <div class="empty-icon"><i class="fas fa-paper-plane"></i></div>
                            <h3>Your Messages</h3>
                            <p>Select a chat to start messaging</p>
                        </div>
                        <div id="active-chat-ui" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                            <div class="chat-header-bar">
                                <i class="fas fa-arrow-left back-btn" onclick="closeChatMobile()"></i>
                                <img src="" id="chat-header-pic" style="width:40px; height:40px; border-radius:50%;">
                                <div class="header-info">
                                    <span id="chat-header-name">User</span>
                                    <span id="chat-header-status">Loading...</span>
                                </div>
                            </div>
                            <div class="messages-feed" id="messages-feed"></div>
                            
                            <div id="file-preview-area">
                                <span id="preview-filename"></span>
                                <i class="fas fa-times" style="cursor:pointer; color:#fff;" onclick="clearChatFile()"></i>
                            </div>

                            <div class="chat-input-zone">
                                <label for="chat-file-btn" style="cursor:pointer; color:var(--primary); font-size:20px;"><i class="fas fa-paperclip"></i></label>
                                <input type="file" id="chat-file-btn" hidden onchange="handleChatFileSelect(this)">
                                <input type="text" id="chat-input" class="chat-input" placeholder="Type a message...">
                                <button class="btn-send" id="send-msg-btn" onclick="sendPrivateMsg()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-profile" class="view-section hidden">
                    <div class="profile-header">
                        <div class="p-avatar-container">
                            <img src="" id="p-img" class="p-pic-xl">
                        </div>
                        <div class="p-details">
                            <div class="p-top-row" id="p-action-row"></div>
                            <ul class="p-stats-row">
                                <li><span class="stat-num" id="p-post-count">0</span> posts</li>
                                <li><span class="stat-num" id="p-followers">0</span> followers</li>
                                <li><span class="stat-num" id="p-following">0</span> following</li>
                            </ul>
                            <div class="p-bio-section">
                                <span class="p-realname" id="p-name">Full Name</span>
                                <div id="p-gender-display" style="font-size:12px; color:#aaa; margin-bottom:5px;"></div>
                                <div id="p-bio" style="color:#f5f5f5;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="profile-tabs">
                        <div class="tab-item active"><i class="fas fa-th"></i> POSTS</div>
                        <div class="tab-item"><i class="fas fa-bookmark"></i> SAVED</div>
                        <div class="tab-item"><i class="fas fa-user-tag"></i> TAGGED</div>
                    </div>
                    <div class="profile-grid" id="p-grid"></div>
                </div>
            </div>

            <div class="right-sidebar">
                <div class="sugg-title">Suggested Agents</div>
                <div id="suggestions-list"></div>
            </div>

        </div>

        <div class="mobile-nav">
            <i class="fas fa-home" style="color:#fff; font-size:24px;" onclick="nav('home')"></i>
            <i class="fas fa-search" style="color:#fff; font-size:24px;" onclick="nav('search')"></i>
            <i class="fas fa-envelope" style="color:#fff; font-size:24px;" onclick="nav('messages')"></i>
            <i class="fas fa-user" style="color:#fff; font-size:24px;" onclick="nav('profile')"></i>
        </div>

        <div class="fab-btn" onclick="openPostModal()">
            <i class="fas fa-plus"></i>
        </div>
    </div>

    <div id="new-post-modal" class="modal-overlay">
        <div class="modal-box" style="width: 500px;">
            <h3 style="margin-bottom: 20px; color:var(--primary);">INITIATE TRANSMISSION</h3>
            
            <label for="post-file-input" class="btn" style="background:#333; color:#fff; padding:10px 20px; display:inline-block; margin-bottom:20px;">
                <i class="fas fa-camera"></i> Select Image Data
            </label>
            <input type="file" id="post-file-input" hidden accept="image/*">
            
            <img src="" id="new-post-preview-img" class="new-post-preview">
            
            <input type="text" id="post-caption" class="auth-input" placeholder="Enter Title / Caption..." style="margin-bottom: 20px;">
            
            <div style="display:flex; gap:10px;">
                <button class="auth-btn btn" onclick="createPost()">TRANSMIT</button>
                <button class="btn" style="background:#333; color:#fff; flex:1;" onclick="closePostModal()">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Edit Profile</h3>
            <input type="text" id="edit-name" class="auth-input" placeholder="Name">
            <input type="text" id="edit-bio" class="auth-input" placeholder="Bio">
            <select id="edit-gender" class="auth-input" style="background:var(--surface);">
                <option value="" disabled selected>Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
            </select>
            <input type="file" id="file-up-avi" style="margin-top:10px;">
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="auth-btn btn" onclick="saveProfile()">Save</button>
                <button class="btn" style="background:#333; color:#fff; flex:1;" onclick="document.getElementById('edit-modal').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box" style="width: 300px; padding: 0;">
            <ul class="settings-list">
                <li>Apps and Websites</li>
                <li>QR Code</li>
                <li>Notifications</li>
                <li>Settings and privacy</li>
                <li>Supervision</li>
                <li onclick="logout()">Log Out</li>
                <li style="color:#fff; border-top: 1px solid #333;" onclick="document.getElementById('settings-modal').style.display='none'">Cancel</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, doc, setDoc, where, getDocs, arrayUnion, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGK533ImY8ePta_MAOTCq1aW4FjFhBusw",
            authDomain: "cyberhub-177cc.firebaseapp.com",
            projectId: "cyberhub-177cc",
            storageBucket: "cyberhub-177cc.firebasestorage.app",
            messagingSenderId: "396278945910",
            appId: "1:396278945910:web:619c94a73492edc3072757"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let userNow = null;
        let activeChatUser = null;
        let unsubscribeChat = null;
        let unsubscribeUserStatus = null;
        let unsubscribeProfile = null; // FIXED: Prevent listener leak
        let selectedChatFile = null;
        let selectedPostFile = null;

        // AUTH
        window.login = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-pass').value); } catch(e) { alert(e.message); } };
        window.register = async () => {
            const name = document.getElementById('r-name').value;
            const username = document.getElementById('r-user').value.toLowerCase();
            const email = document.getElementById('r-email').value;
            const pass = document.getElementById('r-pass').value;
            if(!name || !username || !email || !pass) return alert("Fill all fields");
            document.getElementById('loader').style.display='flex';
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const pic = `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`;
                await updateProfile(cred.user, { displayName: username, photoURL: pic });
                await setDoc(doc(db, "users", cred.user.uid), { uid: cred.user.uid, name: name, username: username, photo: pic, email: email, bio: "CyberHub Agent", gender:"", followers: [], lastSeen: serverTimestamp() });
                location.reload();
            } catch(e) { alert(e.message); document.getElementById('loader').style.display='none'; }
        };
        window.logout = () => signOut(auth);
        window.toggleAuth = () => { const l=document.getElementById('login-form'), r=document.getElementById('reg-form'); if(l.classList.contains('hidden')){l.classList.remove('hidden');r.classList.add('hidden');}else{l.classList.add('hidden');r.classList.remove('hidden');} };

        // APP INIT
        onAuthStateChanged(auth, (u) => {
            document.getElementById('loader').style.display='none';
            if(u) { 
                userNow = u; 
                document.getElementById('auth-view').style.display='none'; 
                document.getElementById('app-view').style.display='block'; 
                initApp();
                updatePresence();
                setInterval(updatePresence, 60000); 
            }
            else { document.getElementById('auth-view').style.display='flex'; document.getElementById('app-view').style.display='none'; }
        });

        async function updatePresence() {
            if(userNow) { await updateDoc(doc(db, "users", userNow.uid), { lastSeen: serverTimestamp() }); }
        }

        function initApp() {
            onSnapshot(query(collection(db, "posts"), orderBy("time", "desc")), (snap) => {
                const c = document.getElementById('feed-list'); c.innerHTML='';
                if(snap.empty) { c.innerHTML = '<div class="empty-feed">No Transmissions Detected</div>'; }
                else {
                    snap.forEach(d => { const p=d.data(); const l=p.likes&&p.likes.includes(userNow.uid)?'liked':'';
                        c.innerHTML+=`<div class="post-card"><div class="post-header"><img src="${p.avatar}" class="post-avatar" onclick="openProfile('${p.uid}')"><span style="font-weight:600; cursor:pointer;" onclick="openProfile('${p.uid}')">${p.user}</span></div><img src="${p.img}" class="post-img"><div class="post-actions"><i class="fas fa-heart ${l}" onclick="like('${d.id}')"></i></div><div><b>${p.user}</b> ${p.cap}</div></div>`;
                    });
                }
            });
            loadSuggestions();
            loadMsgContacts();
        }

        // --- NEW POST LOGIC (Fixed Stuck Loading) ---
        window.openPostModal = () => { document.getElementById('new-post-modal').style.display='flex'; };
        window.closePostModal = () => { 
            document.getElementById('new-post-modal').style.display='none';
            document.getElementById('post-file-input').value = "";
            document.getElementById('post-caption').value = "";
            document.getElementById('new-post-preview-img').style.display = 'none';
            document.getElementById('new-post-preview-img').src = "";
            selectedPostFile = null;
        };

        document.getElementById('post-file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) { alert("Only image data accepted."); e.target.value = ""; return; }
            if (file.size > 5 * 1024 * 1024) { alert("File too large. Max 5MB."); e.target.value = ""; return; }
            selectedPostFile = file;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = document.getElementById('new-post-preview-img');
                img.src = ev.target.result;
                img.style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.createPost = async () => {
            const caption = document.getElementById('post-caption').value;
            if(!selectedPostFile) { alert("Image data required."); return; }
            if(!caption) { alert("Title/Caption required."); return; }

            document.getElementById('loader').style.display='flex';
            try {
                const storageRef = ref(storage, `posts/${userNow.uid}/${Date.now()}_${selectedPostFile.name}`);
                await uploadBytes(storageRef, selectedPostFile);
                const downloadURL = await getDownloadURL(storageRef);

                await addDoc(collection(db, "posts"), {
                    uid: userNow.uid,
                    user: userNow.displayName,
                    avatar: userNow.photoURL,
                    img: downloadURL,
                    cap: caption,
                    time: serverTimestamp(),
                    likes: []
                });

                closePostModal();
                nav('home');
            } catch (error) {
                console.error("Upload failed:", error);
                alert("Upload Failed: " + error.message + "\nCheck console for details.");
            } finally {
                document.getElementById('loader').style.display='none';
            }
        };

        // --- MESSAGES ---
        function loadMsgContacts() {
            const q = query(collection(db, "users"), limit(50));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('contact-list');
                let html = `<div class="contact-item" onclick="startPrivateChat({uid:'global_wwc', username:'WWC', name:'Global Chat', photo:'https://ui-avatars.com/api/?name=WWC&background=00f3ff&color=000'})"><img src="https://ui-avatars.com/api/?name=WWC&background=00f3ff&color=000" class="c-avatar"><div><div class="c-name">WWC</div><div class="c-user">Global Chat</div></div></div>`;
                snap.forEach(docSnap => {
                    const u = docSnap.data();
                    if(u.uid === userNow.uid) return;
                    html += `<div class="contact-item" onclick='startPrivateChat(${JSON.stringify(u)})'>
                                <img src="${u.photo}" class="c-avatar">
                                <div><div class="c-name">${u.name || u.username}</div></div>
                                <i class="fas fa-trash delete-chat-btn" onclick="deleteContactFromList(event, this)"></i>
                             </div>`;
                });
                list.innerHTML = html;
            });
        }

        window.deleteContactFromList = (event, element) => {
            event.stopPropagation();
            if(confirm("Remove from view?")) { element.closest('.contact-item').remove(); }
        };

        window.startPrivateChat = (targetUser) => {
            activeChatUser = targetUser;
            document.getElementById('empty-chat-state').classList.add('hidden');
            document.getElementById('active-chat-ui').classList.remove('hidden');
            document.getElementById('active-chat-ui').style.display = 'flex';
            document.getElementById('msg-window').classList.add('open');

            document.getElementById('chat-header-name').innerText = targetUser.name || targetUser.username;
            document.getElementById('chat-header-pic').src = targetUser.photo;
            
            if(unsubscribeUserStatus) unsubscribeUserStatus();
            if(targetUser.uid !== 'global_wwc') {
                unsubscribeUserStatus = onSnapshot(doc(db, "users", targetUser.uid), (docSnap) => {
                    if(docSnap.exists()) {
                        const data = docSnap.data();
                        const lastSeen = data.lastSeen ? data.lastSeen.toDate() : null;
                        const now = new Date();
                        const statusEl = document.getElementById('chat-header-status');
                        
                        if(lastSeen && (now - lastSeen) < 120000) {
                            statusEl.innerHTML = '<span class="online-dot">●</span> Online';
                            statusEl.style.color = "#fff";
                        } else {
                            statusEl.innerText = lastSeen ? "Last seen " + formatTime(lastSeen) : "Offline";
                            statusEl.style.color = "#a8a8a8";
                        }
                    }
                });
            } else {
                document.getElementById('chat-header-status').innerText = "Always Online";
            }

            let chatId = (targetUser.uid === 'global_wwc') ? 'global_wwc' : [userNow.uid, targetUser.uid].sort().join("_");
            
            if(unsubscribeChat) unsubscribeChat();
            const q = query(collection(db, "chats", chatId, "messages"), orderBy("time", "asc"));
            unsubscribeChat = onSnapshot(q, (snap) => {
                const feed = document.getElementById('messages-feed');
                feed.innerHTML = "";
                snap.forEach(docSnap => {
                    const m = docSnap.data();
                    const cls = m.uid === userNow.uid ? 'msg-mine' : 'msg-other';
                    const nameTag = (targetUser.uid === 'global_wwc' && m.uid !== userNow.uid) ? `<div class="msg-username">${m.user}</div>` : '';
                    
                    let content = '';
                    if(m.mediaUrl) {
                        if(m.mediaType && m.mediaType.startsWith('image/')) {
                            content = `<img src="${m.mediaUrl}" class="msg-image" onclick="window.open(this.src)">`;
                        } else {
                            content = `<a href="${m.mediaUrl}" target="_blank" class="msg-file-link"><i class="fas fa-file"></i> Attachment</a>`;
                        }
                        if(m.text) content += `<div style="margin-top:5px;">${m.text}</div>`;
                    } else {
                        content = m.text;
                    }

                    let timeStr = "";
                    if(m.time) { timeStr = formatTime(m.time.toDate()); }

                    feed.innerHTML += `<div class="msg-bubble ${cls}">${nameTag}${content}<div class="msg-time">${timeStr}</div></div>`;
                });
                feed.scrollTop = feed.scrollHeight;
            });
        };

        function formatTime(date) {
            let hours = date.getHours();
            let minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; 
            minutes = minutes < 10 ? '0'+minutes : minutes;
            return hours + ':' + minutes + ' ' + ampm;
        }

        window.handleChatFileSelect = (input) => {
            if(input.files && input.files[0]) {
                selectedChatFile = input.files[0];
                document.getElementById('file-preview-area').style.display = 'flex';
                document.getElementById('preview-filename').innerText = "Attached: " + selectedChatFile.name;
            }
        };

        window.clearChatFile = () => {
            selectedChatFile = null;
            document.getElementById('chat-file-btn').value = "";
            document.getElementById('file-preview-area').style.display = 'none';
        };

        window.sendPrivateMsg = async () => {
            const txt = document.getElementById('chat-input').value;
            if((!txt && !selectedChatFile) || !activeChatUser) return;
            
            const btn = document.getElementById('send-msg-btn');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                let chatId = (activeChatUser.uid === 'global_wwc') ? 'global_wwc' : [userNow.uid, activeChatUser.uid].sort().join("_");
                let mediaUrl = null;
                let mediaType = null;

                if(selectedChatFile) {
                    if (selectedChatFile.size > 5 * 1024 * 1024) { throw new Error("File too large. Max 5MB."); }
                    const storageRef = ref(storage, `chat_files/${chatId}/${Date.now()}_${selectedChatFile.name}`);
                    await uploadBytes(storageRef, selectedChatFile);
                    mediaUrl = await getDownloadURL(storageRef);
                    mediaType = selectedChatFile.type;
                }

                await addDoc(collection(db, "chats", chatId, "messages"), { 
                    text: txt, 
                    uid: userNow.uid, 
                    user: userNow.displayName, 
                    time: serverTimestamp(),
                    mediaUrl: mediaUrl,
                    mediaType: mediaType
                });

                document.getElementById('chat-input').value = "";
                clearChatFile();
            } catch (e) {
                alert("Message failed: " + e.message);
            } finally {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        };
        window.closeChatMobile = () => document.getElementById('msg-window').classList.remove('open');

        // --- PROFILE (FIXED LISTENER LEAK) ---
        window.openProfile = (uid) => {
            if(!uid) uid = userNow.uid;
            
            // Unsubscribe previous profile listener to avoid conflicts
            if(unsubscribeProfile) unsubscribeProfile();
            
            nav('profile');
            
            unsubscribeProfile = onSnapshot(doc(db, "users", uid), (s) => {
                if(s.exists()){ 
                    const d=s.data(); 
                    document.getElementById('p-img').src=d.photo; 
                    document.getElementById('p-name').innerText=d.name; 
                    document.getElementById('p-bio').innerText=d.bio;
                    document.getElementById('p-gender-display').innerText=d.gender || "";
                    document.getElementById('p-followers').innerText=d.followers?d.followers.length:0;
                    document.getElementById('p-following').innerText=d.following?d.following.length:0;
                    
                    const row = document.getElementById('p-action-row');
                    if(uid === userNow.uid) {
                        row.innerHTML = `<h2 class="p-username">${d.username}</h2><button class="btn-insta-edit" onclick="openEditModal()">Edit Profile</button><button class="btn-insta-edit">Archive</button><i class="fas fa-cog settings-cog" onclick="openSettings()"></i>`;
                        document.getElementById('edit-name').value=d.name; 
                        document.getElementById('edit-bio').value=d.bio;
                        document.getElementById('edit-gender').value=d.gender || "";
                    } else {
                        row.innerHTML = `<h2 class="p-username">${d.username}</h2><button class="btn-insta-action" onclick="follow('${d.uid}')">Follow</button><button class="btn-insta-edit" onclick='nav("messages"); startPrivateChat(${JSON.stringify(d)})'>Message</button>`;
                    }
                } else {
                    alert("User not found!");
                }
            });
            
            onSnapshot(query(collection(db, "posts"), where("uid", "==", uid)), (s)=>{
                const g=document.getElementById('p-grid'); g.innerHTML=''; document.getElementById('p-post-count').innerText=s.size;
                s.forEach(d=>g.innerHTML+=`<div class="grid-post-wrap"><img src="${d.data().img}" class="grid-img"></div>`);
            });
        };

        // --- SEARCH & FOLLOW ---
        async function loadSuggestions() {
            const q = query(collection(db, "users"), limit(20));
            const snap = await getDocs(q);
            const list = document.getElementById('suggestions-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(u.uid === userNow.uid) return;
                list.innerHTML += `<div class="user-row"><div class="u-info" onclick="openProfile('${u.uid}')"><img src="${u.photo}" class="u-pic"><div><div style="font-weight:bold; font-size:13px;">${u.username}</div><div style="color:var(--text-grey); font-size:11px;">${u.name}</div></div></div><button class="u-btn" onclick="follow('${u.uid}')">Follow</button></div>`;
            });
        }

        window.searchUsers = async () => {
            const val = document.getElementById('search-input').value.toLowerCase();
            const res = document.getElementById('search-results');
            if(val.length < 1) { res.innerHTML = ""; return; }
            const snap = await getDocs(collection(db, "users"));
            res.innerHTML = "";
            snap.forEach(docSnap => {
                const u = docSnap.data();
                if(u.uid === userNow.uid) return;
                if (u.username.toLowerCase().includes(val) || u.name.toLowerCase().includes(val)) {
                    res.innerHTML += `<div class="user-result"><div class="u-info" onclick="openProfile('${u.uid}')"><img src="${u.photo}" class="u-pic"><div><b>${u.username}</b><br><small>${u.name}</small></div></div></div>`;
                }
            });
        };

        window.follow = async(id)=>{try{await updateDoc(doc(db,"users",userNow.uid),{following:arrayUnion(id)});await updateDoc(doc(db,"users",id),{followers:arrayUnion(userNow.uid)});alert("Followed!");}catch(e){alert(e.message)}};
        window.like = async(pid)=>{const r=doc(db,"posts",pid);const s=await getDoc(r);const l=s.data().likes||[];if(l.includes(userNow.uid)){await updateDoc(r,{likes:arrayRemove(userNow.uid)})}else{await updateDoc(r,{likes:arrayUnion(userNow.uid)})}};
        
        window.openSettings=()=>document.getElementById('settings-modal').style.display='flex';
        window.openEditModal=()=>document.getElementById('edit-modal').style.display='flex';
        let newAvi = null;
        document.getElementById('file-up-avi').onchange = (e) => { const r = new FileReader(); r.readAsDataURL(e.target.files[0]); r.onload = (ev) => newAvi = ev.target.result; };
        window.saveProfile=async()=>{
            const n=document.getElementById('edit-name').value;
            const b=document.getElementById('edit-bio').value;
            const g=document.getElementById('edit-gender').value;
            const d = {name:n, bio:b, gender:g};
            if(newAvi) { d.photo = newAvi; await updateProfile(userNow, {photoURL:newAvi}); }
            await updateDoc(doc(db,"users",userNow.uid), d);
            document.getElementById('edit-modal').style.display='none';
        };

        window.nav = (v, el) => {
            if(v === 'profile' && !el) { /* Programmatic */ }
            else if(v === 'profile' && el) { openProfile(userNow.uid); }
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+v).classList.remove('hidden');
            if(el) { document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); }
        };
    </script>
</body>
</html>
