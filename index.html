<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CyberHub | Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #00f3ff;
            --bg: #050505;
            --surface: #0f0f0f;
            --border: #333;
            --text: #f5f5f5;
            --text-grey: #a8a8a8;
            --input-bg: #1a1a1a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .cyber-font { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
        .btn { cursor: pointer; border: none; font-weight: 600; transition: 0.3s; border-radius: 4px; }
        
        /* --- LOADER --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .spinner {
            width: 50px; height: 50px; border: 3px solid rgba(0, 243, 255, 0.2); 
            border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;
            box-shadow: 0 0 15px var(--primary);
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- AUTH --- */
        #auth-view {
            width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center;
            flex-direction: column; background: #000;
            background-image: radial-gradient(circle at 50% 50%, rgba(0, 243, 255, 0.05) 0%, transparent 50%);
        }
        .auth-box { 
            width: 350px; padding: 40px; border: 1px solid var(--border); 
            text-align: center; background: rgba(15, 15, 15, 0.8); backdrop-filter: blur(10px);
            border-radius: 12px; box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .auth-input { 
            width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid var(--border); 
            color: #fff; margin-bottom: 10px; border-radius: 6px; font-size: 14px; transition: 0.3s;
        }
        .auth-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }
        .auth-btn { 
            width: 100%; padding: 12px; background: var(--primary); color: #000; 
            margin-top: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
        }
        .auth-btn:hover { box-shadow: 0 0 15px var(--primary); }
        .link { color: var(--primary); cursor: pointer; margin-top: 15px; display: inline-block; font-size: 0.9rem; }

        /* --- LAYOUT --- */
        #app-view { display: none; height: 100vh; }
        .main-layout { display: grid; grid-template-columns: 250px 1fr; max-width: 1200px; margin: 0 auto; height: 100%; }

        /* --- SIDEBAR --- */
        .sidebar { border-right: 1px solid var(--border); padding: 40px 20px; display: flex; flex-direction: column; height: 100%; }
        .logo { font-size: 1.8rem; color: var(--primary); margin-bottom: 50px; padding-left: 10px; text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 8px; color: var(--text); cursor: pointer; margin-bottom: 8px; transition: 0.3s; }
        .nav-item:hover { background: rgba(0, 243, 255, 0.1); color: var(--primary); transform: translateX(5px); }
        .nav-item.active { font-weight: 700; color: var(--primary); background: rgba(0, 243, 255, 0.05); border-left: 3px solid var(--primary); }
        .nav-item i { font-size: 22px; width: 30px; }

        /* --- CONTENT --- */
        .content-area { overflow-y: scroll; position: relative; }
        
        /* --- FEED --- */
        .feed-container { max-width: 500px; margin: 0 auto; padding: 40px 20px 100px 20px; }
        .post-card { margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }
        .post-img { width: 100%; border-radius: 8px; border: 1px solid var(--border); }
        .post-actions { padding: 10px 0; font-size: 24px; display: flex; gap: 20px; }
        .liked { color: #ff3040; text-shadow: 0 0 10px rgba(255, 48, 64, 0.5); }

        /* --- SEARCH VIEW --- */
        #view-search { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
        .search-bar-wrap { position: sticky; top: 0; background: var(--bg); padding-bottom: 20px; z-index: 10; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .search-input { width: 100%; padding: 15px 20px; background: var(--surface); border: 1px solid var(--border); color: #fff; border-radius: 30px; font-size: 16px; transition: 0.3s; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); }
        
        .user-result { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid var(--border); transition: 0.2s; border-radius: 8px; }
        .user-result:hover { background: var(--surface); transform: scale(1.01); }
        .ur-left { display: flex; align-items: center; gap: 15px; }
        .ur-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }
        .ur-btn-group { display: flex; gap: 10px; }
        .btn-follow { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 6px 14px; font-size: 13px; border-radius: 4px; }
        .btn-follow:hover { background: var(--primary); color: #000; box-shadow: 0 0 10px var(--primary); }
        .btn-msg { background: #333; color: #fff; padding: 6px 14px; font-size: 13px; border-radius: 4px; }

        /* --- MESSAGES --- */
        #view-messages { max-width: 800px; margin: 0 auto; padding: 20px; height: 100%; display: flex; flex-direction: column; }
        .chat-box { flex: 1; border: 1px solid var(--border); background: var(--surface); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .chat-header { padding: 15px; border-bottom: 1px solid var(--border); background: #0a0a0a; font-weight: bold; color: var(--primary); letter-spacing: 1px; }
        .chat-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg-bubble { padding: 10px 15px; border-radius: 20px; max-width: 70%; font-size: 14px; }
        .msg-mine { align-self: flex-end; background: var(--primary); color: #000; box-shadow: 0 0 10px rgba(0, 243, 255, 0.3); }
        .msg-other { align-self: flex-start; background: #333; color: #fff; }
        .chat-input-area { padding: 15px; background: #0a0a0a; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 10px; background: #111; border: 1px solid var(--border); color: #fff; border-radius: 20px; }
        .chat-input:focus { border-color: var(--primary); }

        /* --- INSTAGRAM PROFILE --- */
        #view-profile { max-width: 935px; margin: 0 auto; padding: 30px 20px; }
        .profile-header { display: flex; margin-bottom: 44px; }
        .p-avatar-container { flex-grow: 1; margin-right: 30px; display: flex; justify-content: center; }
        .p-pic-xl { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid var(--primary); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
        
        .p-details { flex-grow: 2; color: #f5f5f5; }
        .p-top-row { display: flex; align-items: center; margin-bottom: 20px; gap: 20px; }
        .p-username { font-size: 22px; font-weight: 300; font-family: 'Inter'; }
        
        .btn-insta-edit { background-color: #363636; border: 1px solid #363636; border-radius: 8px; color: #fff; font-weight: 600; padding: 7px 16px; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .btn-insta-edit:hover { background-color: #262626; border-color: var(--primary); color: var(--primary); }
        
        .p-stats-row { display: flex; gap: 40px; margin-bottom: 20px; font-size: 16px; list-style: none; padding: 0; }
        .stat-num { font-weight: 700; color: #fff; }
        .p-bio-section { font-size: 14px; line-height: 1.5; }
        .p-realname { font-weight: 600; display: block; color: var(--primary); }
        
        .profile-tabs { border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 60px; margin-bottom: 20px; }
        .tab-item { padding-top: 15px; color: var(--text-grey); font-size: 12px; font-weight: 600; letter-spacing: 1px; cursor: pointer; display: flex; align-items: center; gap: 6px; border-top: 1px solid transparent; margin-top: -1px; transition: 0.2s; }
        .tab-item.active { color: var(--primary); border-top: 1px solid var(--primary); }
        
        .profile-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .grid-post-wrap { position: relative; aspect-ratio: 1/1; cursor: pointer; overflow: hidden; }
        .grid-img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .grid-post-wrap:hover .grid-img { transform: scale(1.05); }
        .grid-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; color:#fff; font-weight:bold; gap:20px; backdrop-filter: blur(2px); }
        .grid-post-wrap:hover .grid-overlay { display: flex; }

        /* --- MOBILE --- */
        .mobile-nav { display: none; }
        @media (max-width: 800px) {
            .main-layout { display: block; }
            .sidebar { display: none; }
            .mobile-nav { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.9); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 15px; z-index: 100; backdrop-filter: blur(10px); }
            .feed-container, #view-profile, #view-search { padding-bottom: 80px; }
            .profile-header { flex-wrap: wrap; margin-bottom: 24px; gap: 15px; }
            .p-avatar-container { margin-right: 0; }
            .p-pic-xl { width: 77px; height: 77px; }
            .p-details { width: calc(100% - 100px); }
            .p-top-row { margin-bottom: 10px; flex-direction: column; align-items: flex-start; gap: 10px; }
            .p-stats-row { width: 100%; justify-content: space-around; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 12px 0; margin-bottom: 10px; order: 2; }
            .p-bio-section { margin-bottom: 15px; order: 1; }
            .profile-grid { gap: 3px; }
        }

        /* --- FUTURISTIC MODAL --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 2000; display: none; 
            align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }
        .modal-box { 
            background: #0f0f0f; padding: 30px; width: 400px; border-radius: 15px; 
            border: 1px solid var(--primary); text-align: center;
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.15);
        }
        .modal-title { font-family: 'Orbitron'; color: var(--primary); font-size: 20px; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .edit-input-group { margin-bottom: 15px; text-align: left; }
        .edit-label { font-size: 12px; color: var(--text-grey); margin-bottom: 5px; display: block; margin-left: 5px; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="auth-view">
        <div class="auth-box">
            <h1 class="cyber-font" style="color:var(--primary); margin-bottom: 20px; font-size: 30px;">CYBERHUB</h1>
            <div id="login-form">
                <input type="email" id="l-email" class="auth-input" placeholder="Email">
                <input type="password" id="l-pass" class="auth-input" placeholder="Password">
                <button class="auth-btn btn" onclick="login()">Log In</button>
                <div class="link" onclick="toggleAuth()">Create New Account</div>
            </div>
            <div id="reg-form" class="hidden">
                <input type="text" id="r-name" class="auth-input" placeholder="Full Name">
                <input type="text" id="r-user" class="auth-input" placeholder="Username">
                <input type="email" id="r-email" class="auth-input" placeholder="Email">
                <input type="password" id="r-pass" class="auth-input" placeholder="Password">
                <button class="auth-btn btn" onclick="register()">Sign Up</button>
                <div class="link" onclick="toggleAuth()">Back to Login</div>
            </div>
        </div>
    </div>

    <div id="app-view">
        <div class="main-layout">
            <div class="sidebar">
                <div class="logo cyber-font">CYBERHUB</div>
                <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-home"></i> <span>Home</span></div>
                <div class="nav-item" onclick="nav('search', this)"><i class="fas fa-search"></i> <span>Search</span></div>
                <div class="nav-item" onclick="nav('messages', this)"><i class="fas fa-envelope"></i> <span>Messages</span></div>
                <div class="nav-item" onclick="nav('profile', this)"><i class="fas fa-user"></i> <span>Profile</span></div>
                <div class="nav-item" onclick="logout()" style="margin-top:auto;"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></div>
            </div>

            <div class="content-area">
                <div id="view-home" class="view-section">
                    <div class="feed-container" id="feed-list"></div>
                </div>

                <div id="view-search" class="view-section hidden">
                    <div class="search-bar-wrap">
                        <input type="text" class="search-input" id="search-input" placeholder="Search Agents..." onkeyup="searchUsers()">
                    </div>
                    <div id="search-results">
                        <div style="text-align:center; color:#555; margin-top:50px;">Initialize Search Protocol...</div>
                    </div>
                </div>

                <div id="view-messages" class="view-section hidden">
                    <div class="chat-box">
                        <div class="chat-header">ENCRYPTED CHAT</div>
                        <div class="chat-list" id="msg-list"></div>
                        <div class="chat-input-area">
                            <input type="text" id="msg-input" class="chat-input" placeholder="Transmit data...">
                            <button class="btn" style="background:var(--primary); color:#000; padding:0 20px;" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>

                <div id="view-profile" class="view-section hidden">
                    <div class="profile-header">
                        <div class="p-avatar-container">
                            <img src="" id="p-img" class="p-pic-xl">
                        </div>
                        <div class="p-details">
                            <div class="p-top-row">
                                <h2 id="p-username" class="p-username">username</h2>
                                <button class="btn-insta-edit" onclick="openEditModal()">Edit Profile</button>
                                <button class="btn-insta-edit" style="margin-left: 8px;">Archive</button>
                                <i class="fas fa-cog" style="margin-left: 15px; font-size: 20px; cursor: pointer;"></i>
                            </div>
                            <ul class="p-stats-row">
                                <li><span class="stat-num" id="p-post-count">0</span> posts</li>
                                <li><span class="stat-num" id="p-follower-count">0</span> followers</li>
                                <li><span class="stat-num" id="p-following-count">0</span> following</li>
                            </ul>
                            <div class="p-bio-section">
                                <span class="p-realname" id="p-fullname">Full Name</span>
                                <div id="p-bio">No bio yet.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-tabs">
                        <div class="tab-item active"><i class="fas fa-th"></i> POSTS</div>
                        <div class="tab-item"><i class="fas fa-bookmark"></i> SAVED</div>
                        <div class="tab-item"><i class="fas fa-user-tag"></i> TAGGED</div>
                    </div>

                    <div class="profile-grid" id="p-grid"></div>
                </div>
            </div>
        </div>
        
        <div class="mobile-nav">
            <i class="fas fa-home" style="color:#fff; font-size:24px;" onclick="nav('home')"></i>
            <i class="fas fa-search" style="color:#fff; font-size:24px;" onclick="nav('search')"></i>
            <i class="fas fa-envelope" style="color:#fff; font-size:24px;" onclick="nav('messages')"></i>
            <i class="fas fa-user" style="color:#fff; font-size:24px;" onclick="nav('profile')"></i>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">UPDATE IDENTITY</div>
            <img src="" id="edit-preview" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px; border: 2px solid var(--primary);">
            <br>
            <span class="link" onclick="document.getElementById('file-up-avi').click()">Change Avatar</span>
            <input type="file" id="file-up-avi" hidden accept="image/*" onchange="previewAvi(this)">
            
            <div class="edit-input-group" style="margin-top: 20px;">
                <label class="edit-label">USERNAME</label>
                <input type="text" id="edit-user" class="auth-input" placeholder="New Username">
            </div>

            <div class="edit-input-group">
                <label class="edit-label">FULL NAME</label>
                <input type="text" id="edit-name" class="auth-input" placeholder="Full Name">
            </div>

            <div class="edit-input-group">
                <label class="edit-label">BIO / STATUS</label>
                <input type="text" id="edit-bio" class="auth-input" placeholder="Bio">
            </div>
            
            <div style="display:flex; gap:10px; margin-top: 25px;">
                <button class="auth-btn btn" onclick="saveProfile()">SAVE CHANGES</button>
                <button class="btn" style="background:#333; color:#fff; flex:1; margin-top:10px;" onclick="document.getElementById('edit-modal').style.display='none'">CANCEL</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, doc, setDoc, where, getDocs, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBGK533ImY8ePta_MAOTCq1aW4FjFhBusw",
            authDomain: "cyberhub-177cc.firebaseapp.com",
            projectId: "cyberhub-177cc",
            storageBucket: "cyberhub-177cc.firebasestorage.app",
            messagingSenderId: "396278945910",
            appId: "1:396278945910:web:619c94a73492edc3072757"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userNow = null;

        // AUTH
        window.login = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-pass').value); } catch(e) { alert(e.message); } };
        window.register = async () => {
            const name = document.getElementById('r-name').value;
            const username = document.getElementById('r-user').value.toLowerCase();
            const email = document.getElementById('r-email').value;
            const pass = document.getElementById('r-pass').value;
            if(!name || !username || !email || !pass) return alert("Fill all fields");
            document.getElementById('loader').style.display='flex';
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const pic = `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`;
                await updateProfile(cred.user, { displayName: username, photoURL: pic });
                await setDoc(doc(db, "users", cred.user.uid), { uid: cred.user.uid, name: name, username: username, photo: pic, email: email, bio: "CyberHub Agent", followers: [], following: [] });
                location.reload();
            } catch(e) { alert(e.message); document.getElementById('loader').style.display='none'; }
        };
        window.logout = () => signOut(auth);
        window.toggleAuth = () => { const l=document.getElementById('login-form'), r=document.getElementById('reg-form'); if(l.classList.contains('hidden')){l.classList.remove('hidden');r.classList.add('hidden');}else{l.classList.add('hidden');r.classList.remove('hidden');} };

        // APP LOGIC
        onAuthStateChanged(auth, (u) => {
            document.getElementById('loader').style.display='none';
            if(u) { userNow = u; document.getElementById('auth-view').style.display='none'; document.getElementById('app-view').style.display='block'; initApp(); }
            else { document.getElementById('auth-view').style.display='flex'; document.getElementById('app-view').style.display='none'; }
        });

        function initApp() {
            // LOAD PROFILE
            onSnapshot(doc(db, "users", userNow.uid), (s) => {
                if(s.exists()){ const d=s.data(); 
                document.getElementById('p-img').src=d.photo; document.getElementById('p-username').innerText=d.username; 
                document.getElementById('p-fullname').innerText=d.name; document.getElementById('p-bio').innerText=d.bio;
                document.getElementById('p-follower-count').innerText=d.followers?d.followers.length:0;
                document.getElementById('p-following-count').innerText=d.following?d.following.length:0;
                // Pre-fill edit
                document.getElementById('edit-preview').src=d.photo; document.getElementById('edit-name').value=d.name; document.getElementById('edit-bio').value=d.bio;
                document.getElementById('edit-user').value=d.username;
                }
            });
            // FEED
            onSnapshot(query(collection(db, "posts"), orderBy("time", "desc")), (snap) => {
                const c = document.getElementById('feed-list'); c.innerHTML='';
                snap.forEach(d => { const p=d.data(); const l=p.likes&&p.likes.includes(userNow.uid)?'liked':'';
                    c.innerHTML+=`<div class="post-card"><div class="post-header"><img src="${p.avatar}" class="post-avatar"><span style="font-weight:600">${p.user}</span></div><img src="${p.img}" class="post-img" ondblclick="toggleLike('${d.id}')"><div class="post-actions"><i class="fas fa-heart ${l}" style="cursor:pointer;" onclick="toggleLike('${d.id}')"></i></div><div><b>${p.user}</b> ${p.cap}</div></div>`;
                });
            });
            // MY GRID
            onSnapshot(query(collection(db, "posts"), where("uid", "==", userNow.uid)), (snap) => {
                const g=document.getElementById('p-grid'); g.innerHTML=''; document.getElementById('p-post-count').innerText=snap.size;
                snap.forEach(d=>{
                    const p = d.data();
                    const likes = p.likes ? p.likes.length : 0;
                    g.innerHTML+=`
                    <div class="grid-post-wrap">
                        <img src="${p.img}" class="grid-img">
                        <div class="grid-overlay"><i class="fas fa-heart"></i> ${likes}</div>
                    </div>`;
                });
            });
            // CHAT
            onSnapshot(query(collection(db, "chats"), orderBy("time", "asc")), (snap) => {
                const l=document.getElementById('msg-list'); l.innerHTML='';
                snap.forEach(d=>{const m=d.data(); const cls=m.uid===userNow.uid?'msg-mine':'msg-other'; l.innerHTML+=`<div class="msg-bubble ${cls}"><b>${m.user}:</b> ${m.txt}</div>`;});
                l.scrollTop=l.scrollHeight;
            });
        }

        // --- SEARCH & FOLLOW ---
        window.searchUsers = async () => {
            const val = document.getElementById('search-input').value.toLowerCase();
            const res = document.getElementById('search-results');
            if(val.length < 2) return;
            const q = query(collection(db, "users"), where("username", ">=", val), where("username", "<=", val+"\uf8ff"));
            const snap = await getDocs(q);
            res.innerHTML = '';
            if(snap.empty) { res.innerHTML='<div style="text-align:center;margin-top:20px;color:#555">No agent found</div>'; return;}
            snap.forEach(d => {
                const u = d.data();
                if(u.uid === userNow.uid) return;
                res.innerHTML += `
                <div class="user-result">
                    <div class="ur-left">
                        <img src="${u.photo}" class="ur-pic">
                        <div><div style="font-weight:bold">${u.username}</div><div style="font-size:12px;color:#777">${u.name}</div></div>
                    </div>
                    <div class="ur-btn-group">
                        <button class="btn-follow" onclick="follow('${u.uid}')">Follow</button>
                        <button class="btn-msg" onclick="nav('messages')">Msg</button>
                    </div>
                </div>`;
            });
        };

        window.follow = async (targetId) => {
            try {
                await updateDoc(doc(db, "users", userNow.uid), { following: arrayUnion(targetId) });
                await updateDoc(doc(db, "users", targetId), { followers: arrayUnion(userNow.uid) });
                alert("Connection Established!");
            } catch(e) { alert("Error: "+e.message); }
        };

        // --- OTHER FUNCTIONS ---
        window.toggleLike = async(pid)=>{const r=doc(db,"posts",pid);const s=await getDoc(r);const l=s.data().likes||[];if(l.includes(userNow.uid)){await updateDoc(r,{likes:arrayRemove(userNow.uid)})}else{await updateDoc(r,{likes:arrayUnion(userNow.uid)})}};
        window.sendMsg = async()=>{const i=document.getElementById('msg-input');if(!i.value)return;await addDoc(collection(db,"chats"),{uid:userNow.uid,user:userNow.displayName,txt:i.value,time:serverTimestamp()});i.value=''};
        
        let newAvi=null;
        window.openEditModal=()=>document.getElementById('edit-modal').style.display='flex';
        window.previewAvi=(el)=>{const f=el.files[0];const r=new FileReader();r.onload=(e)=>{const i=new Image();i.src=e.target.result;i.onload=()=>{const c=document.createElement('canvas');c.width=150;c.height=150;c.getContext('2d').drawImage(i,0,0,150,150);newAvi=c.toDataURL('image/jpeg',0.8);document.getElementById('edit-preview').src=newAvi;}};r.readAsDataURL(f);};
        window.saveProfile=async()=>{
            const n=document.getElementById('edit-name').value;
            const b=document.getElementById('edit-bio').value;
            const u=document.getElementById('edit-user').value.toLowerCase();
            
            document.getElementById('loader').style.display='flex';
            const d={name:n,bio:b,username:u};
            if(newAvi){d.photo=newAvi;await updateProfile(userNow,{photoURL:newAvi, displayName:u});}
            else { await updateProfile(userNow,{displayName:u}); }
            
            await updateDoc(doc(db,"users",userNow.uid),d);
            document.getElementById('edit-modal').style.display='none';
            document.getElementById('loader').style.display='none';
        };

        window.nav = (v, el) => {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+v).classList.remove('hidden');
            if(el) { document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); }
        };
    </script>
</body>
</html>
