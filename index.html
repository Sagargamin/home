<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CyberHub | Nexus</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #00f3ff;
            --primary-glow: rgba(0, 243, 255, 0.3);
            --bg-dark: #05070a;
            --glass-panel: rgba(20, 25, 35, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --danger: #ff3344;
            --success: #00ff99;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1a2035 0%, #05070a 60%);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevents body scroll, handles inside elements */
            display: flex;
            flex-direction: column;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .cyber-font { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; }
        .btn { cursor: pointer; border: none; transition: 0.2s; border-radius: 8px; font-weight: 600; }
        .clickable { cursor: pointer; }

        /* --- LOADER --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 3px solid rgba(0,243,255,0.1);
            border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
            box-shadow: 0 0 15px var(--primary-glow);
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- AUTH SCREEN --- */
        #auth-view {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            background: #000; position: absolute; z-index: 1000;
        }
        .auth-container {
            width: 90%; max-width: 400px; padding: 40px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-color);
            border-radius: 20px; text-align: center; backdrop-filter: blur(20px);
        }
        .auth-input {
            width: 100%; padding: 15px; margin-bottom: 15px; background: rgba(0,0,0,0.5);
            border: 1px solid var(--border-color); color: #fff; border-radius: 10px; font-size: 16px;
        }
        .auth-input:focus { border-color: var(--primary); box-shadow: 0 0 10px var(--primary-glow); }
        .auth-btn {
            width: 100%; padding: 15px; background: var(--primary); color: #000;
            font-family: 'Orbitron'; font-weight: 700; font-size: 16px; margin-top: 10px;
        }
        .link { color: var(--primary); margin-top: 20px; display: block; font-size: 14px; cursor: pointer; text-decoration: underline; }

        /* --- MAIN LAYOUT (CSS GRID) --- */
        #app-view { width: 100%; height: 100%; display: none; }
        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr 320px; /* Fixed Sidebar, Flexible Content, Fixed Sidebar */
            height: 100vh;
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* --- LEFT SIDEBAR --- */
        .sidebar {
            background: rgba(10, 12, 16, 0.8); border-right: 1px solid var(--border-color);
            padding: 30px; display: flex; flex-direction: column; backdrop-filter: blur(10px);
        }
        .logo {
            font-family: 'Orbitron'; font-size: 28px; color: #fff; margin-bottom: 50px;
            text-shadow: 0 0 10px var(--primary);
        }
        .nav-item {
            display: flex; align-items: center; gap: 15px; padding: 15px;
            color: var(--text-muted); border-radius: 12px; margin-bottom: 5px;
            font-size: 16px; font-weight: 500;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: rgba(0, 243, 255, 0.15); color: var(--primary); border: 1px solid rgba(0,243,255,0.1); }
        .nav-item i { width: 25px; text-align: center; font-size: 20px; }

        /* --- MIDDLE CONTENT AREA --- */
        .content-area {
            position: relative;
            overflow-y: auto; /* Scroll only inside middle area */
            display: flex; flex-direction: column;
            background: rgba(0,0,0,0.2);
        }

        /* Hero Header */
        .hero-header {
            text-align: center; padding: 60px 20px; border-bottom: 1px solid var(--border-color);
            background: linear-gradient(180deg, rgba(0,243,255,0.05) 0%, transparent 100%);
        }
        .hero-title { font-family: 'Orbitron'; font-size: 40px; color: #fff; margin-bottom: 5px; }
        .hero-sub { color: var(--primary); font-size: 14px; letter-spacing: 3px; font-weight: 600; }

        /* Agent Grid (Home) */
        .grid-container { padding: 30px; }
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Responsive Grid */
            gap: 20px;
        }
        .agent-card {
            background: var(--glass-panel); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 25px; text-align: center;
            display: flex; flex-direction: column; align-items: center;
            transition: 0.3s;
        }
        .agent-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .agent-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 2px solid #333; }
        .agent-name { font-weight: 700; color: #fff; font-size: 16px; margin-bottom: 2px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .agent-user { color: var(--text-muted); font-size: 13px; margin-bottom: 15px; }
        .agent-btn {
            background: transparent; border: 1px solid var(--primary); color: var(--primary);
            padding: 8px 0; width: 100%; border-radius: 6px; font-size: 12px; font-weight: 700;
        }
        .agent-btn:hover { background: var(--primary); color: #000; }

        /* --- RIGHT SIDEBAR --- */
        .right-sidebar {
            background: rgba(10, 12, 16, 0.6); border-left: 1px solid var(--border-color);
            padding: 30px 20px; overflow-y: auto;
        }
        .section-title { font-size: 12px; color: var(--text-muted); letter-spacing: 1px; font-weight: 700; margin-bottom: 20px; }
        .user-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .u-info { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .u-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .u-btn { color: var(--primary); font-size: 12px; font-weight: 700; background: none; border: none; }

        /* --- MESSAGES VIEW (Fixed Layout) --- */
        #view-messages { height: 100%; display: grid; grid-template-columns: 300px 1fr; }
        .msg-list-panel { border-right: 1px solid var(--border-color); display: flex; flex-direction: column; background: rgba(0,0,0,0.3); }
        .msg-header { padding: 20px; font-family: 'Orbitron'; font-size: 20px; border-bottom: 1px solid var(--border-color); }
        .contacts-scroll { flex: 1; overflow-y: auto; }
        .contact-item { padding: 15px 20px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s; position: relative;}
        .contact-item:hover { background: rgba(255,255,255,0.05); }
        .contact-item img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
        .del-btn { position: absolute; right: 15px; color: #555; display: none; font-size: 14px; }
        .contact-item:hover .del-btn { display: block; color: var(--danger); }

        .chat-area { display: flex; flex-direction: column; background: #000; position: relative; }
        .chat-top-bar { 
            height: 70px; padding: 0 25px; border-bottom: 1px solid var(--border-color); 
            display: flex; align-items: center; gap: 15px; background: rgba(20,25,35,0.9);
        }
        .chat-feed { 
            flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; 
            background: radial-gradient(circle, rgba(0,243,255,0.02) 0%, transparent 70%);
        }
        .msg-bubble { max-width: 70%; padding: 12px 18px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; }
        .msg-in { align-self: flex-start; background: #1f2937; color: #fff; border-bottom-left-radius: 4px; }
        .msg-out { align-self: flex-end; background: var(--primary); color: #000; border-bottom-right-radius: 4px; font-weight: 500; }
        .msg-img { max-width: 250px; border-radius: 10px; margin-top: 5px; cursor: pointer; }
        .msg-meta { font-size: 10px; opacity: 0.7; text-align: right; margin-top: 5px; display: block; }

        .chat-input-bar { 
            padding: 20px; background: #0f1219; border-top: 1px solid var(--border-color); 
            display: flex; align-items: center; gap: 15px; 
        }
        .chat-field { 
            flex: 1; padding: 12px 20px; border-radius: 50px; background: #1a1d26; border: 1px solid var(--border-color); 
            color: #fff; font-size: 15px; 
        }
        .send-btn { 
            width: 45px; height: 45px; border-radius: 50%; background: var(--primary); 
            display: flex; align-items: center; justify-content: center; font-size: 18px; color: #000;
        }
        .blocked-banner { width: 100%; padding: 15px; background: #2a0000; color: var(--danger); text-align: center; font-weight: bold; display: none; }
        .pending-banner { width: 100%; padding: 15px; background: #1a1d26; color: #aaa; text-align: center; font-size: 13px; display: none; }

        /* --- PROFILE VIEW --- */
        #view-profile { padding: 40px; max-width: 800px; margin: 0 auto; }
        .profile-head { display: flex; align-items: center; gap: 40px; margin-bottom: 40px; }
        .profile-pic { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--bg-dark); outline: 3px solid var(--primary); }
        .stats { display: flex; gap: 40px; list-style: none; font-size: 18px; margin: 20px 0; }
        .stat-val { font-weight: 700; color: #fff; cursor: pointer; }
        .stat-val:hover { color: var(--primary); }
        .action-btn { padding: 8px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; }
        .btn-blue { background: var(--primary); color: #000; }
        .btn-grey { background: rgba(255,255,255,0.1); color: #fff; }

        /* --- NOTIFICATIONS --- */
        .notif-card { 
            display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255,255,255,0.03); 
            border-radius: 10px; margin-bottom: 10px; border: 1px solid transparent; transition: 0.2s;
        }
        .notif-card:hover { border-color: var(--primary); background: rgba(255,255,255,0.05); }
        .notif-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
        .btn-xs { padding: 5px 12px; font-size: 11px; border-radius: 4px; margin-right: 5px; font-weight: bold; }

        /* --- SEARCH --- */
        .search-bar { 
            width: 100%; padding: 18px 25px; border-radius: 50px; background: rgba(255,255,255,0.05); 
            border: 1px solid var(--border-color); color: #fff; font-size: 16px; margin-bottom: 30px; 
        }
        .search-bar:focus { border-color: var(--primary); }

        /* --- MODALS --- */
        .modal-wrap { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); 
            display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px);
        }
        .modal-content { background: #111; padding: 30px; border-radius: 20px; border: 1px solid var(--border-color); width: 400px; text-align: center; }
        
        /* --- MOBILE RESPONSIVE --- */
        .mobile-nav { display: none; }
        .back-btn { display: none; font-size: 20px; color: #fff; }

        @media (max-width: 1024px) {
            .main-layout { grid-template-columns: 240px 1fr; } 
            .right-sidebar { display: none; }
        }

        @media (max-width: 768px) {
            .main-layout { display: block; }
            .sidebar { display: none; }
            .mobile-nav {
                position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%;
                background: rgba(20, 25, 35, 0.9); backdrop-filter: blur(15px); border: 1px solid var(--border-color);
                display: flex; justify-content: space-around; padding: 15px; border-radius: 25px; z-index: 100;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            }
            .mobile-nav i { font-size: 24px; color: #888; transition: 0.2s; }
            .mobile-nav i:hover, .mobile-nav i:active { color: var(--primary); transform: translateY(-3px); }
            
            .content-area { height: 100vh; padding-bottom: 100px; background: var(--bg-dark); }
            #view-messages { display: block; }
            .msg-list-panel { width: 100%; height: 100%; border: none; background: transparent; }
            .msg-window { 
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; 
                transform: translateX(100%); transition: 0.3s; background: #000;
            }
            .msg-window.open { transform: translateX(0); }
            .back-btn { display: block; }
            
            .profile-header { flex-direction: column; text-align: center; gap: 20px; }
            .stats { justify-content: center; width: 100%; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); padding: 15px 0; }
        }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="auth-view">
        <div class="auth-container">
            <h1 class="cyber-font" style="color:var(--primary); font-size: 32px; margin-bottom: 10px;">CYBERHUB</h1>
            <p style="color:var(--text-muted); margin-bottom: 30px;">SECURE • CONNECT • ENCRYPT</p>
            
            <div id="login-form">
                <input type="email" id="l-email" class="auth-input" placeholder="Enter Email ID">
                <input type="password" id="l-pass" class="auth-input" placeholder="Enter Password">
                <button class="btn auth-btn" onclick="login()">INITIALIZE LINK</button>
                <div class="link" onclick="toggleAuth()">Create New Identity</div>
            </div>

            <div id="reg-form" class="hidden">
                <input type="text" id="r-name" class="auth-input" placeholder="Display Name">
                <input type="text" id="r-user" class="auth-input" placeholder="Codename (@user)">
                <input type="email" id="r-email" class="auth-input" placeholder="Secure Email">
                <input type="password" id="r-pass" class="auth-input" placeholder="Set Password">
                <button class="btn auth-btn" onclick="register()">REGISTER AGENT</button>
                <div class="link" onclick="toggleAuth()">Return to Login</div>
            </div>
        </div>
    </div>

    <div id="app-view">
        <div class="main-layout">
            
            <div class="sidebar">
                <div class="logo cyber-font">CYBERHUB</div>
                <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-globe"></i> <span>Nexus Grid</span></div>
                <div class="nav-item" onclick="nav('search', this)"><i class="fas fa-search"></i> <span>Search</span></div>
                <div class="nav-item" onclick="nav('notify', this)"><i class="fas fa-bell"></i> <span>Alerts</span></div>
                <div class="nav-item" onclick="nav('messages', this)"><i class="fas fa-envelope"></i> <span>Comms</span></div>
                <div class="nav-item" onclick="nav('profile', this)"><i class="fas fa-user-circle"></i> <span>Identity</span></div>
                <div class="nav-item" onclick="openSettings()" style="margin-top:auto;"><i class="fas fa-cog"></i> <span>System</span></div>
            </div>

            <div class="content-area">
                
                <div id="view-home" class="view-section">
                    <div class="hero-header">
                        <h1 class="hero-title">CYBERHUB</h1>
                        <p class="hero-sub">GLOBAL AGENT DIRECTORY</p>
                    </div>
                    <div class="grid-container">
                        <div id="feed-list" class="agent-grid"></div>
                    </div>
                </div>

                <div id="view-search" class="view-section hidden" style="padding: 40px;">
                    <input type="text" class="search-bar" id="search-input" placeholder="Scan for agent signal..." onkeyup="searchUsers()">
                    <div id="search-results"></div>
                </div>

                <div id="view-notify" class="view-section hidden" style="padding: 30px; max-width: 700px; margin: 0 auto;">
                    <h2 style="font-family:'Orbitron'; border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:20px;">SYSTEM LOGS</h2>
                    <div id="notify-list">
                        <div style="text-align:center; color:#555;">No activity detected.</div>
                    </div>
                </div>

                <div id="view-messages" class="view-section hidden">
                    <div class="msg-list-panel">
                        <div class="msg-header">CHANNELS</div>
                        <div class="contacts-scroll" id="contact-list"></div>
                    </div>
                    <div class="msg-window" id="msg-window">
                        <div class="empty-chat" id="empty-chat-state" style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <i class="fas fa-comments" style="font-size:50px; color:#333; margin-bottom:20px;"></i>
                            <h3 style="color:#555;">Select a frequency</h3>
                        </div>
                        
                        <div id="active-chat-ui" class="hidden" style="display:flex; flex-direction:column; height:100%;">
                            <div class="chat-top-bar" id="chat-main-header">
                                <i class="fas fa-arrow-left back-btn" onclick="closeChatMobile()"></i>
                                <img src="" id="chat-header-pic" style="width:40px; height:40px; border-radius:50%;">
                                <div>
                                    <div id="chat-header-name" style="font-weight:bold; color:#fff;">User</div>
                                    <div id="chat-header-status" style="font-size:12px; color:#888;">Connecting...</div>
                                </div>
                            </div>

                            <div class="chat-feed" id="messages-feed"></div>

                            <div id="file-preview-area" style="padding:10px; background:#111; display:none; border-top:1px solid #333;">
                                <span id="preview-filename" style="font-size:13px; color:var(--primary);"></span>
                                <i class="fas fa-times" style="float:right; cursor:pointer;" onclick="clearChatFile()"></i>
                            </div>

                            <div class="chat-input-bar">
                                <label for="chat-file-btn" style="cursor:pointer; color:var(--primary); font-size:20px;"><i class="fas fa-paperclip"></i></label>
                                <input type="file" id="chat-file-btn" hidden onchange="handleChatFileSelect(this)">
                                <input type="text" id="chat-input" class="chat-field" placeholder="Type encrypted message...">
                                <button class="btn send-btn" id="send-msg-btn" onclick="sendPrivateMsg()"><i class="fas fa-paper-plane"></i></button>
                            </div>

                            <div id="chat-blocked-msg" class="blocked-banner">CONNECTION BLOCKED</div>
                            <div id="chat-pending-msg" class="pending-banner">CONNECTION REQUEST SENT // WAITING FOR ACKNOWLEDGMENT</div>
                        </div>
                    </div>
                </div>

                <div id="view-profile" class="view-section hidden">
                    <div class="profile-head">
                        <div>
                            <img src="" id="p-img" class="p-pic-xl">
                        </div>
                        <div style="flex:1;">
                            <div style="display:flex; align-items:center; gap:20px; flex-wrap:wrap; margin-bottom:20px;" id="p-action-row"></div>
                            
                            <ul class="stats">
                                <li><span class="stat-val" id="p-followers" onclick="openListModal('followers')">0</span> followers</li>
                                <li><span class="stat-val" id="p-following" onclick="openListModal('following')">0</span> following</li>
                            </ul>
                            
                            <div style="font-size:16px; color:#ccc; line-height:1.6;">
                                <div id="p-name" style="font-weight:700; color:#fff; font-size:18px;"></div>
                                <div id="p-gender-display" style="font-size:12px; color:var(--primary); font-weight:bold; margin-bottom:5px;"></div>
                                <div id="p-bio"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="right-sidebar">
                <div class="section-title">SUGGESTED AGENTS</div>
                <div id="suggestions-list"></div>
            </div>

        </div>

        <div class="mobile-nav">
            <i class="fas fa-globe" onclick="nav('home')"></i>
            <i class="fas fa-search" onclick="nav('search')"></i>
            <i class="fas fa-bell" onclick="nav('notify')"></i>
            <i class="fas fa-envelope" onclick="nav('messages')"></i>
            <i class="fas fa-user-circle" onclick="nav('profile')"></i>
        </div>
    </div>

    <div id="list-modal" class="modal-wrap">
        <div class="modal-content">
            <h3 id="list-title" style="color:var(--primary); margin-bottom:15px; font-family:'Orbitron'">LIST</h3>
            <div id="list-content" style="max-height:300px; overflow-y:auto; text-align:left;"></div>
            <button class="btn" style="margin-top:20px; background:transparent; border:1px solid #555; color:#fff; width:100%; padding:10px;" onclick="document.getElementById('list-modal').style.display='none'">CLOSE</button>
        </div>
    </div>

    <div id="edit-modal" class="modal-wrap">
        <div class="modal-content">
            <h3 style="color:#fff; margin-bottom:20px;">EDIT IDENTITY</h3>
            <input type="text" id="edit-name" class="auth-input" placeholder="Name">
            <input type="text" id="edit-bio" class="auth-input" placeholder="Bio">
            <select id="edit-gender" class="auth-input" style="background:#222;">
                <option value="" disabled selected>Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
            </select>
            <input type="file" id="file-up-avi" style="margin-top:10px; color:#fff;">
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn auth-btn" onclick="saveProfile()">SAVE</button>
                <button class="btn" style="background:#333; color:#fff; flex:1; margin-top:10px;" onclick="document.getElementById('edit-modal').style.display='none'">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-wrap">
        <div class="modal-content" style="width:300px; padding:0;">
            <div style="padding:15px; border-bottom:1px solid #333; cursor:pointer; color:#fff;">Settings</div>
            <div style="padding:15px; border-bottom:1px solid #333; cursor:pointer; color:var(--danger);" onclick="logout()">LOGOUT</div>
            <div style="padding:15px; cursor:pointer; color:#888;" onclick="document.getElementById('settings-modal').style.display='none'">Cancel</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, doc, setDoc, where, getDocs, arrayUnion, arrayRemove, limit, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGK533ImY8ePta_MAOTCq1aW4FjFhBusw",
            authDomain: "cyberhub-177cc.firebaseapp.com",
            projectId: "cyberhub-177cc",
            storageBucket: "cyberhub-177cc.firebasestorage.app",
            messagingSenderId: "396278945910",
            appId: "1:396278945910:web:619c94a73492edc3072757"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let userNow = null;
        let activeChatUser = null;
        let unsubscribeChat = null;
        let unsubscribeUserStatus = null;
        let unsubscribeProfile = null;
        let selectedChatFile = null;
        let activeChatListener = null; 
        let currentProfileData = null;
        let myFollowingList = [];
        let allUsersCache = [];

        // --- AUTH ---
        window.login = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-pass').value); } catch(e) { alert(e.message); } };
        window.register = async () => {
            const name = document.getElementById('r-name').value;
            const username = document.getElementById('r-user').value.toLowerCase();
            const email = document.getElementById('r-email').value;
            const pass = document.getElementById('r-pass').value;
            if(!name || !username || !email || !pass) return alert("Fill all fields");
            document.getElementById('loader').style.display='flex';
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const pic = `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`;
                await updateProfile(cred.user, { displayName: username, photoURL: pic });
                await setDoc(doc(db, "users", cred.user.uid), { uid: cred.user.uid, name: name, username: username, photo: pic, email: email, bio: "CyberHub Agent", gender:"", followers: [], following: [], lastSeen: serverTimestamp() });
                location.reload();
            } catch(e) { alert(e.message); document.getElementById('loader').style.display='none'; }
        };
        window.logout = () => signOut(auth);
        window.toggleAuth = () => { const l=document.getElementById('login-form'), r=document.getElementById('reg-form'); if(l.classList.contains('hidden')){l.classList.remove('hidden');r.classList.add('hidden');}else{l.classList.add('hidden');r.classList.remove('hidden');} };

        // --- INIT ---
        onAuthStateChanged(auth, (u) => {
            document.getElementById('loader').style.display='none';
            if(u) { 
                userNow = u; 
                document.getElementById('auth-view').style.display='none'; 
                document.getElementById('app-view').style.display='block'; 
                initApp();
                updatePresence();
                setInterval(updatePresence, 60000); 
            }
            else { document.getElementById('auth-view').style.display='flex'; document.getElementById('app-view').style.display='none'; }
        });

        async function updatePresence() { if(userNow) { await updateDoc(doc(db, "users", userNow.uid), { lastSeen: serverTimestamp() }); } }

        function initApp() {
            onSnapshot(doc(db, "users", userNow.uid), (docSnap) => {
                if(docSnap.exists()){
                    myFollowingList = docSnap.data().following || [];
                    renderAllUserLists(); 
                }
            });
            onSnapshot(collection(db, "users"), (snap) => {
                allUsersCache = [];
                snap.forEach(docSnap => {
                    const u = docSnap.data();
                    if(u.uid !== userNow.uid) allUsersCache.push(u);
                });
                renderAllUserLists();
            });
            loadMsgContacts();
            listenToNotifications();
        }

        function renderAllUserLists() {
            const feedContainer = document.getElementById('feed-list');
            const suggContainer = document.getElementById('suggestions-list');
            feedContainer.innerHTML = '';
            suggContainer.innerHTML = '';
            let hasSuggestions = false;

            allUsersCache.forEach(u => {
                feedContainer.innerHTML += `
                <div class="agent-card">
                    <img src="${u.photo}" class="agent-img">
                    <div class="agent-name">${u.name}</div>
                    <div class="agent-user">@${u.username}</div>
                    <button class="agent-btn" onclick="openProfile('${u.uid}')">VIEW PROFILE</button>
                </div>`;

                if(!myFollowingList.includes(u.uid)) {
                    hasSuggestions = true;
                    suggContainer.innerHTML += `
                    <div class="user-row">
                        <div class="u-info" onclick="openProfile('${u.uid}')">
                            <img src="${u.photo}" class="u-img">
                            <div><div style="font-weight:700; font-size:14px; color:#fff;">${u.username}</div></div>
                        </div>
                        <button class="u-btn" onclick="follow('${u.uid}')">Connect</button>
                    </div>`;
                }
            });
            if(!hasSuggestions) suggContainer.innerHTML = '<div style="color:#666;text-align:center; font-size:12px;">No new signals.</div>';
        }

        // --- CORE FEATURES ---
        window.openProfile = (uid) => {
            if(!uid) uid = userNow.uid;
            if(unsubscribeProfile) unsubscribeProfile();
            nav('profile');
            unsubscribeProfile = onSnapshot(doc(db, "users", uid), (s) => {
                if(s.exists()){ 
                    const d=s.data(); 
                    currentProfileData = d;
                    document.getElementById('p-img').src=d.photo; 
                    document.getElementById('p-name').innerText=d.name; 
                    document.getElementById('p-bio').innerText=d.bio;
                    document.getElementById('p-gender-display').innerText=d.gender || "";
                    document.getElementById('p-followers').innerText=d.followers?d.followers.length:0;
                    document.getElementById('p-following').innerText=d.following?d.following.length:0;
                    
                    const row = document.getElementById('p-action-row');
                    if(uid === userNow.uid) {
                        row.innerHTML = `<h2 class="p-username">${d.username}</h2><button class="btn-insta-edit" onclick="openEditModal()">Edit</button><button class="btn-insta-edit">Archive</button><i class="fas fa-cog settings-cog" onclick="openSettings()"></i>`;
                        document.getElementById('edit-name').value=d.name; 
                        document.getElementById('edit-bio').value=d.bio;
                        document.getElementById('edit-gender').value=d.gender || "";
                    } else {
                        const isFollowing = d.followers && d.followers.includes(userNow.uid);
                        let btnHtml = isFollowing 
                            ? `<button class="btn-insta-edit" onclick="unfollow('${d.uid}')">Linked</button>`
                            : `<button class="btn-insta-action btn-blue" onclick="follow('${d.uid}')">Connect</button>`;
                        row.innerHTML = `<h2 class="p-username">${d.username}</h2>${btnHtml}<button class="btn-insta-edit" onclick='nav("messages"); startPrivateChat(${JSON.stringify(d)})'>Signal</button>`;
                    }
                }
            });
        };

        function listenToNotifications() {
            const q = query(collection(db, "notifications"), where("targetUid", "==", userNow.uid));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('notify-list');
                list.innerHTML = "";
                if(snap.empty) { list.innerHTML = `<div style="text-align:center;color:#555;margin-top:20px;">No activity detected.</div>`; return; }
                let notifs = [];
                snap.forEach(d => notifs.push({id: d.id, ...d.data()}));
                notifs.sort((a,b) => b.time - a.time);

                notifs.forEach(n => {
                    let actionHtml = "";
                    let contentText = "";
                    if(n.type === 'message_request') {
                        contentText = "requesting secure link.";
                        if(n.status === 'pending') {
                            actionHtml = `<div style="margin-top:5px;"><button class="btn btn-xs btn-success" style="background:#00ff99;color:#000;margin-right:5px;" onclick="respondRequest('${n.chatId}', '${n.id}', 'accept')">ACCEPT</button><button class="btn btn-xs btn-danger" style="background:#ff3344;color:#fff;" onclick="respondRequest('${n.chatId}', '${n.id}', 'deny')">DENY</button></div>`;
                        } else { actionHtml = `<div style="font-size:11px; color:#555; margin-top:5px;">${n.status.toUpperCase()}</div>`; }
                    } else if(n.type === 'follow') contentText = "is tracking your signal.";
                    else if(n.type === 'unfollow') contentText = "stopped tracking.";
                    else if(n.type === 'message') contentText = "encrypted message received.";
                    
                    list.innerHTML += `<div class="notif-card"><img src="${n.actorPic}" class="notif-img"><div style="flex:1;"><div style="font-size:14px; color:#ddd;"><span style="color:var(--primary);font-weight:700;">${n.actorName}</span> ${contentText}</div>${actionHtml}</div></div>`;
                });
            });
        }

        async function createNotification(targetUid, type, chatId = null) {
            if(targetUid === userNow.uid) return;
            await addDoc(collection(db, "notifications"), { targetUid: targetUid, type: type, actorUid: userNow.uid, actorName: userNow.displayName, actorPic: userNow.photoURL, time: serverTimestamp(), chatId: chatId, status: 'pending' });
        }

        window.respondRequest = async (chatId, notifId, action) => {
            const status = (action === 'accept') ? 'accepted' : 'denied';
            await updateDoc(doc(db, "chats", chatId), { status: status });
            await updateDoc(doc(db, "notifications", notifId), { status: status });
        };

        // --- CHAT LOGIC ---
        function loadMsgContacts() {
            const q = query(collection(db, "users"), limit(50));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('contact-list');
                let html = `<div class="contact-item" onclick="startPrivateChat({uid:'global_wwc', username:'WWC', name:'Global Chat', photo:'https://ui-avatars.com/api/?name=WWC&background=00f3ff&color=000'})"><img src="https://ui-avatars.com/api/?name=WWC&background=00f3ff&color=000"><div><div style="font-weight:bold; color:#fff;">WWC</div><div style="font-size:12px; color:#888;">Global Chat</div></div></div>`;
                snap.forEach(docSnap => {
                    const u = docSnap.data();
                    if(u.uid !== userNow.uid) {
                        html += `<div class="contact-item" onclick='startPrivateChat(${JSON.stringify(u)})'>
                                    <img src="${u.photo}" onclick="event.stopPropagation(); openProfile('${u.uid}')">
                                    <div><div style="font-weight:bold; color:#fff;">${u.name || u.username}</div><div style="font-size:12px; color:#777;" id="last-msg-${u.uid}">Decrypting...</div></div>
                                    <i class="fas fa-trash del-btn" onclick="event.stopPropagation(); if(confirm('Hide?')) this.closest('.contact-item').remove()"></i>
                                 </div>`;
                    }
                });
                list.innerHTML = html;
                snap.forEach(docSnap => {
                    const u = docSnap.data();
                    if(u.uid !== userNow.uid) {
                        let chatId = [userNow.uid, u.uid].sort().join("_");
                        const q2 = query(collection(db, "chats", chatId, "messages"), orderBy("time", "desc"), limit(1));
                        onSnapshot(q2, (s) => {
                            const el = document.getElementById(`last-msg-${u.uid}`);
                            if(el && !s.empty) el.innerText = (s.docs[0].data().uid === userNow.uid ? "You: " : "") + (s.docs[0].data().text || "File");
                            else if(el) el.innerText = "Start comms";
                        });
                    }
                });
            });
        }

        window.startPrivateChat = async (targetUser) => {
            activeChatUser = targetUser;
            document.getElementById('empty-chat-state').classList.add('hidden');
            document.getElementById('active-chat-ui').classList.remove('hidden');
            document.getElementById('active-chat-ui').style.display = 'flex';
            document.getElementById('msg-window').classList.add('open');

            document.querySelector('.chat-input-zone').style.display = 'flex';
            document.getElementById('chat-blocked-msg').style.display = 'none';
            document.getElementById('chat-pending-msg').style.display = 'none';

            document.getElementById('chat-header-name').innerText = targetUser.name || targetUser.username;
            document.getElementById('chat-header-pic').src = targetUser.photo;
            
            if(targetUser.uid !== 'global_wwc') {
                document.getElementById('chat-main-header').onclick = () => openProfile(targetUser.uid);
                
                const chatId = [userNow.uid, targetUser.uid].sort().join("_");
                activeChatListener = onSnapshot(doc(db, "chats", chatId), (s) => {
                    if(s.exists()) {
                        const st = s.data().status;
                        if(st === 'denied') {
                            document.querySelector('.chat-input-zone').style.display = 'none';
                            document.getElementById('chat-blocked-msg').style.display = 'block';
                        } else if(st === 'pending' && s.data().requester === userNow.uid) {
                            document.querySelector('.chat-input-zone').style.display = 'none';
                            document.getElementById('chat-pending-msg').style.display = 'block';
                        }
                    }
                });

                unsubscribeUserStatus = onSnapshot(doc(db, "users", targetUser.uid), (d) => {
                    if(d.exists()) {
                        const ls = d.data().lastSeen ? d.data().lastSeen.toDate() : null;
                        const el = document.getElementById('chat-header-status');
                        if(ls && (new Date() - ls) < 120000) { el.innerText = "ONLINE"; el.style.color = "#00ff99"; }
                        else { el.innerText = "OFFLINE"; el.style.color = "#777"; }
                    }
                });
            } else {
                document.getElementById('chat-header-status').innerText = "OPEN CHANNEL";
                document.getElementById('chat-main-header').onclick = null;
            }

            let chatId = (targetUser.uid === 'global_wwc') ? 'global_wwc' : [userNow.uid, targetUser.uid].sort().join("_");
            if(unsubscribeChat) unsubscribeChat();
            const q = query(collection(db, "chats", chatId, "messages"), orderBy("time", "asc"));
            unsubscribeChat = onSnapshot(q, (snap) => {
                const feed = document.getElementById('messages-feed');
                feed.innerHTML = "";
                snap.forEach(docSnap => {
                    const m = docSnap.data();
                    const cls = m.uid === userNow.uid ? 'msg-out' : 'msg-in';
                    const nameTag = (targetUser.uid === 'global_wwc' && m.uid !== userNow.uid) ? `<div style="font-size:10px;color:var(--primary);margin-bottom:2px;">${m.user}</div>` : '';
                    let content = m.text;
                    if(m.mediaUrl) {
                        content = `<img src="${m.mediaUrl}" class="msg-image" onclick="window.open(this.src)">`;
                        if(m.text) content += `<div style="margin-top:5px;">${m.text}</div>`;
                    }
                    const time = m.time ? new Date(m.time.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    feed.innerHTML += `<div class="msg-bubble ${cls}">${nameTag}${content}<span class="msg-meta">${time}</span></div>`;
                });
                feed.scrollTop = feed.scrollHeight;
            });
        };

        window.handleChatFileSelect = (input) => {
            if(input.files && input.files[0]) {
                selectedChatFile = input.files[0];
                document.getElementById('file-preview-area').style.display = 'block';
                document.getElementById('preview-filename').innerText = "File: " + selectedChatFile.name;
            }
        };

        window.clearChatFile = () => {
            selectedChatFile = null;
            document.getElementById('chat-file-btn').value = "";
            document.getElementById('file-preview-area').style.display = 'none';
        };

        window.sendPrivateMsg = async () => {
            const txt = document.getElementById('chat-input').value;
            if((!txt && !selectedChatFile) || !activeChatUser) return;
            const btn = document.getElementById('send-msg-btn');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            try {
                let chatId = (activeChatUser.uid === 'global_wwc') ? 'global_wwc' : [userNow.uid, activeChatUser.uid].sort().join("_");
                
                if(activeChatUser.uid !== 'global_wwc') {
                    const ref = doc(db, "chats", chatId);
                    const snap = await getDoc(ref);
                    if(!snap.exists()) {
                        await setDoc(ref, { status: 'pending', requester: userNow.uid, recipient: activeChatUser.uid, createdAt: serverTimestamp() });
                        createNotification(activeChatUser.uid, 'message_request', chatId);
                    } else if(snap.data().status === 'denied') throw new Error("Connection Denied.");
                }

                let mediaUrl = null, mediaType = null;
                if(selectedChatFile) {
                    if(selectedChatFile.size > 10 * 1024 * 1024) throw new Error("Max file size 10MB");
                    const sRef = ref(storage, `chat_files/${chatId}/${Date.now()}_${selectedChatFile.name}`);
                    await uploadBytes(sRef, selectedChatFile);
                    mediaUrl = await getDownloadURL(sRef);
                    mediaType = selectedChatFile.type;
                }
                await addDoc(collection(db, "chats", chatId, "messages"), { text: txt, uid: userNow.uid, user: userNow.displayName, time: serverTimestamp(), mediaUrl, mediaType });
                
                if(activeChatUser.uid !== 'global_wwc') createNotification(activeChatUser.uid, 'message');
                document.getElementById('chat-input').value = "";
                clearChatFile();
            } catch (e) { alert(e.message); } finally { btn.innerHTML = originalIcon; btn.disabled = false; }
        };
        window.closeChatMobile = () => document.getElementById('msg-window').classList.remove('open');

        // --- UTILS ---
        window.searchUsers = async () => {
            const val = document.getElementById('search-input').value.toLowerCase();
            const res = document.getElementById('search-results');
            if(val.length < 1) { res.innerHTML = ""; return; }
            const snap = await getDocs(collection(db, "users"));
            res.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if (u.username.toLowerCase().includes(val) || u.name.toLowerCase().includes(val)) {
                    res.innerHTML += `<div class="user-result" style="padding:10px; border-bottom:1px solid #333; cursor:pointer;" onclick="openProfile('${u.uid}')"><img src="${u.photo}" style="width:30px;height:30px;border-radius:50%;vertical-align:middle;margin-right:10px;">${u.username}</div>`;
                }
            });
        };

        window.follow = async(id) => {
            try {
                await updateDoc(doc(db,"users",userNow.uid),{following:arrayUnion(id)});
                await updateDoc(doc(db,"users",id),{followers:arrayUnion(userNow.uid)});
                createNotification(id, 'follow');
            } catch(e) { console.error(e); }
        };

        window.unfollow = async(id) => {
            try {
                await updateDoc(doc(db,"users",userNow.uid),{following:arrayRemove(id)});
                await updateDoc(doc(db,"users",id),{followers:arrayRemove(userNow.uid)});
                createNotification(id, 'unfollow');
            } catch(e) { console.error(e); }
        };
        
        window.openSettings=()=>document.getElementById('settings-modal').style.display='flex';
        window.openEditModal=()=>document.getElementById('edit-modal').style.display='flex';
        window.openListModal=async(t)=>{
            if(!currentProfileData) return;
            const l = t==='followers'?currentProfileData.followers:currentProfileData.following;
            const c = document.getElementById('list-content');
            document.getElementById('list-title').innerText=t.toUpperCase();
            document.getElementById('list-modal').style.display='flex';
            c.innerHTML='Loading...';
            if(!l||l.length===0){c.innerHTML='Empty.';return;}
            c.innerHTML='';
            for(const uid of l){
                const d = await getDoc(doc(db,"users",uid));
                if(d.exists()){
                    const u=d.data();
                    c.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #333;cursor:pointer;display:flex;align-items:center;gap:10px;" onclick="openProfile('${u.uid}');document.getElementById('list-modal').style.display='none'"><img src="${u.photo}" style="width:30px;height:30px;border-radius:50%;"><div>${u.username}</div></div>`;
                }
            }
        };
        let newAvi=null;
        document.getElementById('file-up-avi').onchange=(e)=>{const r=new FileReader();r.readAsDataURL(e.target.files[0]);r.onload=(ev)=>newAvi=ev.target.result;};
        window.saveProfile=async()=>{
            const n=document.getElementById('edit-name').value;
            const b=document.getElementById('edit-bio').value;
            const g=document.getElementById('edit-gender').value;
            const d={name:n, bio:b, gender:g};
            if(newAvi){d.photo=newAvi;await updateProfile(userNow,{photoURL:newAvi});}
            await updateDoc(doc(db,"users",userNow.uid),d);
            document.getElementById('edit-modal').style.display='none';
        };

        window.nav = (v, el) => {
            if(v === 'profile' && !el) openProfile(userNow.uid);
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+v).classList.remove('hidden');
            if(el) { document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); }
        };
    </script>
</body>
</html>
